<!DOCTYPE html>
<html>

<head>
    <title>Offline Maps Demo - by lyklinse</title>
    <script type="text/javascript" src="mapfiles/mapapi.js"></script>
    <script type="text/javascript" src="mapfiles/extendjs/drawing-api.js"></script>
    <script type="text/javascript" src="mapfiles/extendjs/curved.line-0.0.2.min.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/radar.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/tools.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/plane.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/line.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/dragzoomcontrol.js"></script>
    <script type="text/javascript" src="mapfiles/myjs/label.js"></script>
    <style type="text/css">
    		
            #color-palette {
                clear: both;
            }

            .color-button {
                width: 14px;
                height: 14px;
                font-size: 0;
                margin: 2px;
                float: left;
                cursor: pointer;
            }

        </style>
    <script>
        var map;
		var drawingManager;
		var mapOptions;

        function LocalMapType() {}

        LocalMapType.prototype.tileSize = new google.maps.Size(256, 256);
        LocalMapType.prototype.maxZoom = 12; //地图显示最大级别
        LocalMapType.prototype.minZoom = 4; //地图显示最小级别
        LocalMapType.prototype.name = "本地地图";
        LocalMapType.prototype.alt = "显示本地地图数据";
        LocalMapType.prototype.getTile = function(coord, zoom, ownerDocument) {
            var img = ownerDocument.createElement("img");
            img.style.width = this.tileSize.width + "px";
            img.style.height = this.tileSize.height + "px";

            mapPicDir = "file:///F:/Study/GIS/mapDownload/googlemaps/roadmap/";
            var curSize = Math.pow(2, zoom);
            strURL = mapPicDir + zoom + "/" + (coord.x % curSize) + "/" + (coord.y % curSize) + ".PNG";

            img.src = strURL;
            return img;
        };

        var localMapType = new LocalMapType();

        function initialize() {
            var myLatlng = new google.maps.LatLng(34.587, 104.312);
            mapOptions = {
              zoom: 4,
              center: myLatlng,
              disableDoubleClickZoom:true,
			  panControl: true,
			  zoomControl: true,
			  mapTypeControl: false,
			  scaleControl: false,
			  streetViewControl: false,
			  overviewMapControl: true,
            }


            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
            map.mapTypes.set('localMap', localMapType); //绑定本地地图类型
            map.setMapTypeId('localMap'); //指定显示本地地图
            map.setOptions({
                draggable: true
            });             

            var polyOptions = {
                    strokeWeight: 0,
                    fillOpacity: 0.45,
                    editable: true,
                    draggable: true                    
            };
            
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingControl:true,
                markerOptions: {
                    draggable: true,
                    icon:new google.maps.MarkerImage('images/plane_90.png')
                },
                polylineOptions: {
                    editable: true,
                    draggable: true
                    //geodesic:true
                },
                rectangleOptions: polyOptions,
                circleOptions: {
                    editable: true,
                    draggable: true,
                    fillOpacity:0
                },
                polygonOptions: polyOptions,
                map: map
            });

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
                drawingManager.setDrawingMode(null);
                if (e.type == google.maps.drawing.OverlayType.POLYLINE) {
                    var newShape = e.overlay;
                    newShape.type = e.type;
                    google.maps.event.addListener(newShape, 'click', function (e) {
                        if (e.vertex !== undefined) {
                            var path = newShape.getPath();
                            path.removeAt(e.vertex);
                            if (path.length < 2) {
                                newShape.setMap(null);
                            }
                        }
                        setSelection(newShape);
                    });
                    var linePath = newShape.getPath();
                    if(trackStartPoint){
                    	linePath.insertAt(0,trackStartPoint);
                    }                   
                    newShape.id = line.id;
                    newShape.dramaId = line.dramaId;
                    newShape.objType = objTypes.LINE;                    					
                    line.flightPath = newShape;
                    drama.push(line);
                    var len = linePath.getLength();
                    trackStartPoint = linePath.getAt(len-1);
                    setSelection(newShape);
                    createLine();
                }else if(e.type==google.maps.drawing.OverlayType.POLYGON){
                    var newShape = e.overlay;
                    newShape.type = e.type;
                    google.maps.event.addListener(newShape, 'click', function (e) {
                        if (e.vertex !== undefined) {
                            var path = newShape.getPaths().getAt(e.path);
                            path.removeAt(e.vertex);
                            if (path.length < 3) {
                                newShape.setMap(null);
                            }                           
                        }
                        setSelection(newShape);
                    });
                    setSelection(newShape);
                }else if(e.type == google.maps.drawing.OverlayType.CIRCLE){
                    var newShape = e.overlay;
                    newShape.type = e.type;
                    google.maps.event.addListener(newShape, 'click', function (e) {
                        setSelection(newShape);
                    });
                    setSelection(newShape);
                    if(drawRadar){
                        google.maps.event.addListener(newShape, 'drag', function (e) {
                            newShape.marker.setPosition(newShape.getCenter());
                        });                        
                        var image = "images/radar.png";
                        var circleCenter = newShape.getCenter();
                        var marker = new google.maps.Marker({
                             position: circleCenter,
                             icon: image,
                             map:map
                        });
                        radar.marker = marker;
                        newShape.marker = marker;
                        newShape.id = radar.id;
                        newShape.objType = objTypes.RADAR;
                        radar.radarCircle = newShape;
                        radarArray.push(radar);
                        createRadar();
                    }else{
                        createCircle();
                    }
                    
                }else if(e.type == google.maps.drawing.OverlayType.MARKER){
                	var newShape = e.overlay;
                    newShape.type = e.type;
                	google.maps.event.addListener(newShape, 'click', function (e) {
                        setSelection(newShape);
                        
                    });
                    plane.object = newShape;
                    objectArray.push(plane);
                    setSelection(newShape);
                }else if(e.type == google.maps.drawing.OverlayType.RECTANGLE){
                    var newShape = e.overlay;
                    setSelection(newShape);
                    google.maps.event.addListener(newShape, 'click', function (e) {
                        setSelection(newShape);
                        
                    });
                    createRectangle();
                }
            });

			map.enableKeyDragZoom({
				boxStyle: {
				  opacity: 0.7
				},
				paneStyle: {
				  backgroundColor: "gray",
				  opacity: 0.1
				}
			});

			map.enableChangeCursor();

            //google.maps.event.addListener(drawingManager, 'drawingmode_changed', clearSelection);
            //google.maps.event.addListener(map, 'click', clearSelection);      

            buildColorPalette();

        }
        
        function testArc(){
            var circle = new createCircle(1, 114.263858,30.699503 ,114.346646,25.756376, 6.28);

        }

        function testCurve(){
            map.getCursorObject().setCursor("crosshair");
        }


		function viewLine(){
			//var vl = selectedShape.getBounds();
            createLine(0,0,0,0,0);
		}
    </script>
</head>

<body onload="initialize()">	
    <div id="map_canvas" style="left:0;top:0;width:100%;height:100%;position:absolute;">

    </div>
    <div id="panel" style="position:absolute;margin-left:1300px;">
    	<div id="color-palette"></div>
    	<!-- <div>
	        <button id="delete-button">Delete Selected Shape</button>
        </div> -->
    </div>

      <div id="panel1" style="width:40%;height:5%;border:1px solid gray;position:absolute;background-color:#cacfd2; margin-top:720px;margin-left:500px">
     	
        <div>

	        <input type="button" value="drawLine" style="width:100px" onclick="dragZoomIn()" />
	        <input type="button" value="createLine" style="width:100px" onclick="createLine()" />
	        <button id="delete-button" onclick="createCirArc()">createCirArc</button>
            <button id="delete-button" onclick="testCurve()">setDragCursor</button>

        </div>
    </div>  

</body>
</html>